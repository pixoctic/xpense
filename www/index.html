<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Xpense Pro</title>
    <style>
        /* --- EXECUTIVE THEME --- */
        :root { 
            --bg: #09090b; --card: #18181b; --primary: #dc2626; --accent: #ef4444; 
            --text: #fafafa; --sub: #a1a1aa; --success: #10b981; --warn: #f59e0b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding-top: max(45px, env(safe-area-inset-top)); padding-bottom: env(safe-area-inset-bottom);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- OFFLINE SCREEN --- */
        #offline-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .wifi-icon { font-size: 50px; margin-bottom: 20px; animation: pulse 2s infinite; }

        /* --- COMPONENTS --- */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .pin-dots { color: var(--primary); font-size: 32px; letter-spacing: 15px; margin-bottom: 40px; }
        .num-btn { width: 70px; height: 70px; border-radius: 50%; border: 1px solid #333; background: #111; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; }
        .num-btn:active { background: var(--primary); }

        #app-content { display: none; height: 100%; flex-direction: column; }
        header { padding: 10px 24px; display: flex; justify-content: space-between; align-items: center; }
        .avatar { width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* DASHBOARD */
        .dashboard { padding: 10px 24px; display: flex; flex-direction: column; align-items: center; }
        .budget-ring { width: 180px; height: 180px; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-bg { fill: none; stroke: #27272a; stroke-width: 12; }
        .ring-progress { fill: none; stroke: var(--primary); stroke-width: 12; stroke-dasharray: 450; stroke-dashoffset: 450; transition: 1s ease-out; stroke-linecap: round; }
        .ring-text { position: absolute; text-align: center; }
        .ring-text h2 { margin: 0; font-size: 28px; font-weight: 700; display:flex; align-items:center; justify-content:center; gap:5px;}
        .edit-icon { font-size: 14px; color: var(--sub); cursor: pointer; }

        /* TABS */
        .nav-bar { display: flex; background: var(--card); margin: 0 24px 10px; border-radius: 12px; padding: 4px; border: 1px solid #27272a; }
        .nav-item { flex: 1; text-align: center; padding: 10px; font-size: 13px; color: var(--sub); border-radius: 8px; }
        .nav-item.active { background: var(--bg); color: var(--text); font-weight: 600; }

        /* VIEWS */
        .view-section { flex: 1; overflow-y: auto; padding: 10px 24px 100px; display: none; }
        .view-section.active { display: block; }

        /* CARDS */
        .petrol-card { background: linear-gradient(135deg, #1e1e24, #000); border: 1px solid #333; padding: 20px; border-radius: 16px; margin-bottom: 15px; position: relative; overflow: hidden; }
        .petrol-card::before { content:'â›½'; position: absolute; right: -10px; bottom: -10px; font-size: 80px; opacity: 0.1; }
        .big-stat { font-size: 32px; font-weight: bold; color: var(--warn); margin: 5px 0; }
        
        .txn-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #27272a; }
        .txn-amt { font-weight: bold; }
        .inc { color: var(--success); } .exp { color: var(--text); }

        /* INPUTS */
        input, select { background: var(--card); border: 1px solid #333; padding: 16px; border-radius: 12px; color: white; width: 100%; margin-bottom: 10px; outline: none; }
        button.btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: 600; width: 100%; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="offline-screen">
        <div class="wifi-icon">ðŸ“¡</div>
        <h2>Connection Lost</h2>
        <p style="color:var(--sub)">Please connect to the internet to use Xpense Cloud.</p>
        <button class="btn" onclick="window.location.reload()" style="width:200px; margin-top:20px;">Try Again</button>
    </div>

    <div id="lock-screen">
        <div class="pin-dots" id="pin-dots">â€¢â€¢â€¢â€¢â€¢â€¢</div>
        <p style="color:#666; font-size:12px; letter-spacing:2px;">SECURE ENTRY</p>
        <div id="numpad" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px;"></div>
    </div>

    <div id="app-content">
        <header>
            <div><h1 style="margin:0; font-size:20px;">Xpense.</h1></div>
            <div class="avatar" onclick="switchTab('profile')">ðŸ‘¤</div>
        </header>

        <div class="dashboard">
            <div class="budget-ring">
                <svg class="ring-svg"><circle class="ring-bg" cx="90" cy="90" r="70"></circle><circle class="ring-progress" id="ring-bar" cx="90" cy="90" r="70"></circle></svg>
                <div class="ring-text">
                    <span style="color:var(--sub); font-size:12px">Current Balance</span>
                    <h2 id="balance">â‚¹0 <span class="edit-icon" onclick="editBalance()">âœŽ</span></h2>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="switchTab('home', this)">Home</div>
            <div class="nav-item" onclick="switchTab('add', this)">+ Add</div>
            <div class="nav-item" onclick="switchTab('petrol', this)">â›½ Petrol</div>
        </div>

        <div id="view-home" class="view-section active">
            <div id="txn-list"></div>
        </div>

        <div id="view-add" class="view-section">
            <input type="number" id="amt" placeholder="â‚¹ Amount">
            <select id="type" onchange="toggleFields()">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
                <option value="lent">Lent Money</option>
            </select>
            <select id="cat"></select>
            <div id="extra-fields"></div>
            <button class="btn" onclick="addTxn()">Confirm</button>
        </div>

        <div id="view-petrol" class="view-section">
            <div class="petrol-card">
                <span style="color:var(--sub); font-size:12px; text-transform:uppercase;">Average Mileage</span>
                <div class="big-stat" id="avg-mileage">-- km/L</div>
                <small style="color:var(--sub)" id="last-odo-display">Odometer: 0 km</small>
            </div>
            
            <h3 style="margin-top:20px; font-size:14px; color:var(--sub)">QUICK LOG</h3>
            <input type="number" id="petrol-amt" placeholder="â‚¹ Fuel Amount">
            <input type="number" id="petrol-odo" placeholder="Current Odometer (km)">
            <button class="btn" style="background:var(--warn); color:black;" onclick="addPetrol()">Log Fuel & Calculate</button>

            <h3 style="margin-top:30px; font-size:14px; color:var(--sub)">FUEL HISTORY</h3>
            <div id="petrol-list"></div>
        </div>
    </div>

    <script>
        const PIN = "121013";
        let inputPin = "";
        let txns = JSON.parse(localStorage.getItem('ex_txns')) || [];
        let cats = ['ðŸ” Food', 'ðŸ›ï¸ Shopping', 'ðŸŽ¬ Fun', 'ðŸ  Bills'];
        let petrolLog = JSON.parse(localStorage.getItem('ex_petrol')) || [];
        let lastOdo = localStorage.getItem('ex_odo') || 0;

        // NETWORK CHECKER
        window.addEventListener('offline', () => document.getElementById('offline-screen').style.display = 'flex');
        window.addEventListener('online', () => document.getElementById('offline-screen').style.display = 'none');

        // LOCK
        const numpad = document.getElementById('numpad');
        [1,2,3,4,5,6,7,8,9,'C',0,'<'].forEach(n => {
            let btn = document.createElement('div');
            btn.className = 'num-btn'; btn.innerText = n==='<'?'âŒ«':n;
            btn.onclick = () => handlePin(n); numpad.appendChild(btn);
        });
        function handlePin(n) {
            if(n==='C') inputPin=""; else if(n==='<') inputPin=inputPin.slice(0,-1); else if(inputPin.length<6) inputPin+=n;
            document.getElementById('pin-dots').innerText = "â€¢".repeat(inputPin.length);
            if(inputPin === PIN) { document.getElementById('lock-screen').style.display='none'; document.getElementById('app-content').style.display='flex'; init(); }
        }

        function init() {
            renderCats(); renderList(); updateStats(); renderPetrol();
        }

        function switchTab(view, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+view).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
        }

        function renderCats() {
            document.getElementById('cat').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function toggleFields() {
            const type = document.getElementById('type').value;
            const box = document.getElementById('extra-fields');
            box.innerHTML = type === 'lent' ? `<input type="text" id="person" placeholder="Name">` : '';
        }

        // --- CORE FEATURES ---

        function editBalance() {
            const currentBal = calculateBal();
            const realBal = prompt(`Current App Balance: â‚¹${currentBal}\nEnter ACTUAL Balance in Bank:`);
            if(realBal && !isNaN(realBal)) {
                const diff = parseFloat(realBal) - currentBal;
                if(diff !== 0) {
                    const type = diff > 0 ? 'income' : 'expense';
                    txns.unshift({ id: Date.now(), amt: Math.abs(diff), type, cat: 'âš™ï¸ Correction', date: new Date().toLocaleDateString() });
                    save(); renderList(); updateStats();
                }
            }
        }

        function addTxn() {
            const amt = parseFloat(document.getElementById('amt').value);
            const type = document.getElementById('type').value;
            const cat = document.getElementById('cat').value;
            if(!amt) return;

            let txn = { id: Date.now(), amt, type, cat, date: new Date().toLocaleDateString() };
            if(type === 'lent') {
                txn.person = document.getElementById('person').value;
                txn.cat = "ðŸ’¸ Lent";
            }

            txns.unshift(txn); save();
            document.getElementById('amt').value = '';
            switchTab('home', document.querySelectorAll('.nav-item')[0]);
            renderList(); updateStats();
        }

        function addPetrol() {
            const amt = parseFloat(document.getElementById('petrol-amt').value);
            const odo = parseFloat(document.getElementById('petrol-odo').value);
            if(!amt || !odo) return alert("Enter Amount and Odometer!");

            let dist = 0, mileage = 0;
            if(lastOdo > 0 && odo > lastOdo) {
                dist = odo - lastOdo;
                const litres = amt / 105; // Approx price
                mileage = (dist / litres).toFixed(1);
            }

            lastOdo = odo;
            localStorage.setItem('ex_odo', odo);
            
            // Add to Main Log AND Petrol Log
            txns.unshift({ id: Date.now(), amt, type: 'expense', cat: 'â›½ Petrol', date: new Date().toLocaleDateString() });
            petrolLog.unshift({ date: new Date().toLocaleDateString(), amt, odo, mileage });
            localStorage.setItem('ex_petrol', JSON.stringify(petrolLog));
            
            save(); renderPetrol(); renderList(); updateStats();
            document.getElementById('petrol-amt').value = '';
            document.getElementById('petrol-odo').value = '';
            alert(mileage > 0 ? `Mileage: ${mileage} km/L` : 'Fuel Logged! Mileage will update next time.');
        }

        function renderPetrol() {
            document.getElementById('last-odo-display').innerText = `Odometer: ${lastOdo} km`;
            
            // Calc Avg Mileage
            const validLogs = petrolLog.filter(l => l.mileage > 0);
            if(validLogs.length > 0) {
                const avg = (validLogs.reduce((a,b) => a + parseFloat(b.mileage), 0) / validLogs.length).toFixed(1);
                document.getElementById('avg-mileage').innerText = `${avg} km/L`;
            }

            document.getElementById('petrol-list').innerHTML = petrolLog.slice(0,5).map(l => `
                <div class="txn-item">
                    <div><span style="color:var(--sub)">${l.date}</span></div>
                    <div style="text-align:right">
                        <div>â‚¹${l.amt}</div>
                        <small style="color:${l.mileage>40?'var(--success)':'var(--warn)'}">${l.mileage > 0 ? l.mileage+' km/L' : 'Refill'}</small>
                    </div>
                </div>
            `).join('');
        }

        function calculateBal() {
            const inc = txns.filter(t=>t.type==='income').reduce((a,b)=>a+b.amt,0);
            const exp = txns.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amt,0);
            const lent = txns.filter(t=>t.type==='lent').reduce((a,b)=>a+b.amt,0);
            return inc - exp - lent;
        }

        function updateStats() {
            const bal = calculateBal();
            document.getElementById('balance').innerHTML = `â‚¹${bal} <span class="edit-icon" onclick="editBalance()">âœŽ</span>`;
            
            // Ring
            const percent = Math.min((txns.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amt,0) / 20000) * 100, 100);
            document.getElementById('ring-bar').style.strokeDashoffset = 450 - (450 * percent / 100);
        }

        function renderList() {
            document.getElementById('txn-list').innerHTML = txns.map(t => `
                <div class="txn-item">
                    <div><h4>${t.person ? 'To: '+t.person : t.cat}</h4><span style="color:var(--sub);font-size:12px">${t.date}</span></div>
                    <div class="txn-amt ${t.type==='income'?'inc':'exp'}">${t.type==='income'?'+':'-'}â‚¹${t.amt}</div>
                </div>`).join('');
        }

        function save() { localStorage.setItem('ex_txns', JSON.stringify(txns)); }

        init();
    </script>
</body>
</html>