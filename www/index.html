<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Xpense Pro Final</title>
    <style>
        /* --- THEME --- */
        :root { 
            --bg: #000000;
            --glass: rgba(22, 22, 24, 0.85);
            --glass-nav: rgba(10, 10, 10, 0.95);
            --border: rgba(255, 255, 255, 0.12);
            --primary: #3b82f6; --accent: #8b5cf6;
            --text: #ffffff; --sub: #9ca3af;
            --danger: #ef4444; --success: #10b981; --warn: #f59e0b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg);
            color: var(--text); font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; padding-top: max(45px, env(safe-area-inset-top)); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            user-select: none;
        }

        /* --- FX --- */
        .aura { position: fixed; width: 300px; height: 300px; filter: blur(90px); opacity: 0.25; z-index: -1; animation: float 10s infinite alternate; }
        .aura.blue { top: -50px; left: -50px; background: var(--primary); }
        .aura.purple { bottom: -50px; right: -50px; background: var(--accent); animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(40px, 40px); } }

        /* --- LOCK SCREEN --- */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-dots { color: var(--primary); font-size: 30px; letter-spacing: 12px; margin-bottom: 20px; min-height: 40px; }
        .lock-msg { color: var(--danger); font-size: 14px; margin-bottom: 20px; height: 20px; font-weight: bold; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .num-btn { width: 75px; height: 75px; border-radius: 50%; border: 1px solid #333; font-size: 24px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); transition:0.1s; }
        .num-btn:active { background: var(--primary); transform: scale(0.9); }
        .num-btn.disabled { opacity: 0.3; pointer-events: none; }

        /* --- HEADER --- */
        header { padding: 15px 24px; display: flex; justify-content: space-between; align-items: center; }
        .greeting-box h1 { font-size: 20px; font-weight: 700; margin: 0; background: linear-gradient(to right, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .greeting-box span { font-size: 12px; color: var(--sub); text-transform: uppercase; letter-spacing: 1px; }
        .profile-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border); overflow: hidden; background: #222; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .profile-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* --- DASHBOARD --- */
        .dashboard { padding: 0 24px 20px; }
        .card { 
            background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 24px; padding: 25px; 
            text-align: center; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .bal-val { font-size: 42px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; text-shadow: 0 0 20px rgba(59, 130, 246, 0.3); letter-spacing: -1px; }
        .edit-pen { font-size: 14px; color: var(--sub); opacity: 0.3; cursor: pointer; transition: 0.3s; }
        .edit-pen:active { opacity: 1; transform: scale(1.2); }
        .blur-mode { filter: blur(10px); }
        .eye-icon { font-size: 16px; color: var(--sub); cursor: pointer; position: absolute; top: 20px; right: 20px; opacity: 0.5; }

        .budget-wrap { margin-top: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; height: 32px; position: relative; overflow: hidden; display:flex; align-items:center; padding: 0 10px; }
        .budget-fill { position: absolute; top:0; left:0; height:100%; background: linear-gradient(90deg, var(--primary), var(--accent)); opacity: 0.3; width: 0%; transition: 1s ease; }
        .budget-text { position: relative; z-index: 2; font-size: 11px; color: #fff; width: 100%; display: flex; justify-content: space-between; font-weight: 600; align-items: center; }
        .budget-line { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--primary); width: 0%; transition: 1s ease; z-index: 3; }
        .target-edit { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); }

        /* --- MONTH NAV --- */
        .month-nav { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 5px 0 15px; }
        .month-btn { background: none; border: none; color: var(--sub); font-size: 20px; cursor: pointer; padding: 10px; }
        .month-label { font-size: 15px; font-weight: 600; color: #fff; width: 140px; text-align: center; letter-spacing: 0.5px; }

        /* --- VIEWS --- */
        .view-container { flex: 1; overflow-y: auto; padding-bottom: 100px; scroll-behavior: smooth; }
        .view { padding: 0 24px; display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }

        /* --- COMPONENTS --- */
        .input-box { width: 100%; background: #111; border: 1px solid var(--border); color: #fff; padding: 16px; border-radius: 14px; font-size: 16px; margin-bottom: 12px; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: var(--primary); background: #161616; }
        .action-btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-size: 16px; font-weight: 700; margin-top: 10px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }

        /* TYPE SWITCHER */
        .type-switch { display: flex; background: #222; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .type-opt { flex: 1; text-align: center; padding: 12px; font-size: 14px; font-weight: 600; color: #666; border-radius: 10px; transition: 0.2s; cursor: pointer; }
        .type-opt.active { background: #333; color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .type-opt.active[data-val="expense"] { background: var(--danger); }
        .type-opt.active[data-val="income"] { background: var(--success); }
        .type-opt.active[data-val="lent"] { background: var(--warn); }

        /* LIST & STATS */
        .txn { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); user-select: none; transition: background 0.2s; }
        .txn.deleting { background: rgba(239, 68, 68, 0.2); }
        .inc { color: var(--success); } .exp { color: var(--text); } .lent { color: var(--warn); }
        .due-tag { color: var(--danger); border: 1px solid var(--danger); font-size: 9px; padding: 2px 4px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .stat-item { margin-bottom: 12px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; color: var(--sub); }
        .stat-track { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--primary); border-radius: 4px; }

        /* --- NAV --- */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--glass-nav); backdrop-filter: blur(20px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0 calc(15px + env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { color: #666; font-size: 10px; text-align: center; width: 60px; }
        .nav-icon { font-size: 22px; margin-bottom: 2px; filter: grayscale(1); opacity: 0.5; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { filter: grayscale(0); opacity: 1; transform: translateY(-3px); text-shadow: 0 0 10px var(--primary); }

        /* --- PROFILE MODAL --- */
        #view-profile { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; padding: 20px; text-align: center; overflow-y: auto; }
        .upload-area { width: 100px; height: 100px; border-radius: 50%; background: #222; margin: 40px auto 20px; position: relative; border: 2px dashed #444; overflow: hidden; }
        .upload-area img { width: 100%; height: 100%; object-fit: cover; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    
    <div class="aura blue"></div>
    <div class="aura purple"></div>

    <div id="lock-screen">
        <div class="pin-dots" id="pin-dots">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
        <div class="lock-msg" id="lock-msg"></div>
        <div class="numpad" id="numpad"></div>
    </div>

    <header>
        <div class="greeting-box">
            <span id="greet-time">Good Morning,</span>
            <h1 id="user-display">User</h1>
        </div>
        <div class="profile-btn" onclick="openProfile()">
            <img id="header-avatar" src="" style="display:none">
            <div id="header-ph" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#666">U</div>
        </div>
    </header>

    <div class="dashboard">
        <div class="card">
            <div class="eye-icon" onclick="togglePrivacy()">üëÅÔ∏è</div>
            
            <div style="font-size:11px; color:var(--sub); text-transform:uppercase; letter-spacing:1px">Net Balance</div>
            <div class="bal-val"><span id="balance">‚Çπ0</span> <span class="edit-pen" onclick="editBalance()">‚úé</span></div>
            
            <div class="budget-wrap">
                <div class="budget-fill" id="budget-fill"></div>
                <div class="budget-line" id="budget-line"></div>
                <div class="budget-text">
                    <span id="spent-display" onclick="tab('stats', document.querySelectorAll('.nav-item')[1])">‚Çπ0 Spent</span>
                    <span class="target-edit" onclick="editBudget(event)">
                        <span id="budget-display">Target: ‚Çπ20k</span> ‚úé
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">&#10094;</button>
        <div class="month-label" id="month-label">Month Year</div>
        <button class="month-btn" onclick="changeMonth(1)">&#10095;</button>
    </div>

    <div class="view-container">
        <div id="view-home" class="view active">
            <div class="input-box" style="padding:10px; background:rgba(255,255,255,0.05); display:flex; align-items:center; margin-bottom:15px">
                <span style="margin-right:10px">üîç</span>
                <input type="text" id="search-box" placeholder="Search..." style="background:none; border:none; color:white; width:100%; outline:none;" onkeyup="filterList()">
            </div>
            <p style="text-align:center; font-size:10px; color:#444; margin-bottom:10px">Hold to delete</p>
            <div id="txn-list"></div>
        </div>

        <div id="view-stats" class="view">
            <h3 style="color:var(--sub); font-size:12px; margin-bottom:15px; text-transform:uppercase">Monthly Breakdown</h3>
            <div id="stats-container"></div>
            <button class="action-btn" style="background:#222; margin-top:30px; font-size:14px" onclick="exportCSV()">Download CSV üì•</button>
        </div>

        <div id="view-add" class="view">
            <div class="type-switch">
                <div class="type-opt active" data-val="expense" onclick="setType('expense')">Expense</div>
                <div class="type-opt" data-val="income" onclick="setType('income')">Income</div>
                <div class="type-opt" data-val="lent" onclick="setType('lent')">Lent</div>
            </div>

            <input type="number" id="amt" class="input-box" placeholder="‚Çπ Amount">
            
            <div id="cat-wrapper">
                <select id="cat" class="input-box" onchange="checkFields()"></select>
            </div>
            
            <div id="lent-fields" style="display:none">
                <input type="text" id="person" class="input-box" placeholder="Borrower Name (Required)">
                <label style="color:var(--sub); font-size:12px; margin-left:5px">DUE DATE</label>
                <input type="date" id="due-date" class="input-box" style="color-scheme:dark">
            </div>

            <div id="petrol-fields" style="display:none; background:rgba(59, 130, 246, 0.1); padding:15px; border-radius:14px; border:1px solid var(--primary); margin-bottom:10px">
                <label style="font-size:12px; color:var(--primary); font-weight:bold; display:block; margin-bottom:10px">‚õΩ FUEL DETAILS</label>
                <input type="number" id="p-price" class="input-box" placeholder="Price per Liter (‚Çπ)" value="105">
                <input type="number" id="p-odo" class="input-box" placeholder="Current Odometer (km)">
            </div>

            <button class="action-btn" onclick="addTxn()">Save Transaction</button>
        </div>

        <div id="view-petrol" class="view">
            <div class="card" style="margin-bottom:15px">
                <div style="font-size:11px; color:var(--sub)">AVG MILEAGE</div>
                <div style="font-size:32px; font-weight:700; color:var(--success)" id="avg-mileage">--</div>
                <div style="font-size:12px; color:var(--sub)" id="odo-display">Odo: 0 km</div>
            </div>
            <h3 style="color:var(--sub); font-size:12px; margin-top:20px">FUEL HISTORY</h3>
            <div id="petrol-list"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="tab('home', this)"><div class="nav-icon">üè†</div>Home</div>
        <div class="nav-item" onclick="tab('stats', this)"><div class="nav-icon">üìä</div>Stats</div>
        <div class="nav-item" onclick="tab('add', this)"><div class="nav-icon">‚ûï</div>Add</div>
        <div class="nav-item" onclick="tab('petrol', this)"><div class="nav-icon">‚õΩ</div>Fuel</div>
    </div>

    <div id="view-profile">
        <div style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer" onclick="closeProfile()">&times;</div>
        <div class="upload-area" onclick="document.getElementById('file-in').click()">
            <img id="profile-preview" src="" style="display:none">
            <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#666">üì∑</div>
        </div>
        <input type="file" id="file-in" accept="image/*" style="display:none" onchange="uploadImg()">
        
        <label style="color:var(--sub); font-size:12px; display:block; text-align:left; margin:10px 0 5px 5%">YOUR NAME</label>
        <input type="text" id="user-name-in" class="input-box" placeholder="Name">
        
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin:20px 0; text-align:left;">
            <label style="color:var(--primary); font-size:12px; font-weight:bold; display:block; margin-bottom:10px">üîî DAILY REMINDER</label>
            <div style="display:flex; gap:10px">
                <input type="time" id="notify-time" class="input-box" style="margin:0">
                <button class="action-btn" style="margin:0; width:auto; font-size:12px" onclick="setReminder()">Set</button>
            </div>
        </div>

        <button class="action-btn" onclick="saveProfile()">Save Settings</button>
        <button class="action-btn" style="background:#222; margin-top:20px; color:var(--danger)" onclick="if(confirm('Delete All Data?')) { localStorage.clear(); location.reload(); }">Reset App</button>
    </div>

    <script>
        const PIN = "121013";
        let inputPin = "";
        let failedAttempts = 0;
        let lockoutTimer = null;
        let pressTimer; // For Long Press
        
        let txns = JSON.parse(localStorage.getItem('x_txns')) || [];
        let petrol = JSON.parse(localStorage.getItem('x_petrol')) || [];
        let user = JSON.parse(localStorage.getItem('x_user')) || { name: 'Kalidas', img: null, budget: 20000, notify: null };
        let lastOdo = localStorage.getItem('x_odo') || 0;
        
        const expenseCats = ['üçî Food', 'üõçÔ∏è Shopping', 'üé¨ Fun', '‚õΩ Petrol', 'üöå Travel', 'üè† Rent', 'üè• Health'];
        const incomeCats = ['üí∞ Salary', 'üíµ Allowance', 'üéÅ Bonus', 'üè¶ Interest', 'ü™ô Other'];
        
        let displayDate = new Date();
        let currentType = 'expense';
        let privacyMode = false;

        function init() {
            renderNumpad(); checkLockout(); loadProfile(); updateGreeting(); renderCats(); refreshView();
            if(user.notify) setInterval(checkReminder, 60000);
            requestNotifyPerm();
        }

        // --- LOCKOUT LOGIC ---
        function checkLockout() {
            const unlockTime = localStorage.getItem('lockout_until');
            if(unlockTime && Date.now() < unlockTime) startLockout(Math.ceil((unlockTime - Date.now())/1000));
        }
        function startLockout(seconds) {
            document.querySelectorAll('.num-btn').forEach(b => b.classList.add('disabled'));
            let s = seconds;
            document.getElementById('lock-msg').innerText = `Locked! Wait ${s}s`;
            if(lockoutTimer) clearInterval(lockoutTimer);
            lockoutTimer = setInterval(() => {
                s--; document.getElementById('lock-msg').innerText = `Locked! Wait ${s}s`;
                if(s <= 0) { clearInterval(lockoutTimer); document.getElementById('lock-msg').innerText = ""; document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('disabled')); localStorage.removeItem('lockout_until'); failedAttempts = 0; }
            }, 1000);
        }
        function handlePin(n) {
            if(localStorage.getItem('lockout_until') && Date.now() < localStorage.getItem('lockout_until')) return;
            if(navigator.vibrate) navigator.vibrate(5);
            if(n==='C') inputPin=""; else if(n==='<') inputPin=inputPin.slice(0,-1); else if(inputPin.length<6) inputPin+=n;
            document.getElementById('pin-dots').innerText = "‚Ä¢".repeat(inputPin.length);
            if(inputPin.length === 6) {
                if(inputPin === PIN) { document.getElementById('lock-screen').style.display='none'; failedAttempts = 0; }
                else { inputPin = ""; document.getElementById('pin-dots').innerText = ""; failedAttempts++; document.getElementById('lock-msg').innerText = `Wrong PIN (${failedAttempts}/3)`; if(failedAttempts >= 3) { localStorage.setItem('lockout_until', Date.now() + 30000); startLockout(30); } }
            }
        }

        // --- CORE VIEW ---
        function refreshView() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('month-label').innerText = `${monthNames[displayDate.getMonth()]} ${displayDate.getFullYear()}`;
            const filteredTxns = txns.filter(t => { const d = new Date(t.date); return d.getMonth() === displayDate.getMonth() && d.getFullYear() === displayDate.getFullYear(); });
            renderList(filteredTxns); renderStats(filteredTxns); updateBudget(filteredTxns); renderPetrolList(); updateBal(); updateGreeting();
        }

        // --- ADD LOGIC ---
        function setType(t) {
            currentType = t;
            document.querySelectorAll('.type-opt').forEach(el => el.classList.remove('active'));
            document.querySelector(`.type-opt[data-val="${t}"]`).classList.add('active');
            
            document.getElementById('cat-wrapper').style.display = (t === 'lent') ? 'none' : 'block';
            document.getElementById('lent-fields').style.display = (t === 'lent') ? 'block' : 'none';
            renderCats(); checkFields();
        }
        
        function renderCats() {
            const cats = currentType === 'income' ? incomeCats : expenseCats;
            document.getElementById('cat').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function addTxn() {
            const amt = parseFloat(document.getElementById('amt').value);
            if(!amt) return;
            let txn = { id: Date.now(), amt, type: currentType, date: new Date().toLocaleDateString('en-US') };
            let note = "";

            if(currentType === 'lent') {
                const p = document.getElementById('person').value;
                if(!p) return alert("Enter Name");
                txn.cat = "Lent: " + p;
                const due = document.getElementById('due-date').value;
                if(due) txn.due = due;
            } else {
                txn.cat = document.getElementById('cat').value;
                if(txn.cat === '‚õΩ Petrol' && currentType === 'expense') {
                    const price = parseFloat(document.getElementById('p-price').value);
                    const odo = parseFloat(document.getElementById('p-odo').value);
                    if(price && odo) {
                        const litres = (amt / price).toFixed(2);
                        let mileage = 0;
                        if(lastOdo > 0 && odo > lastOdo) mileage = ((odo - lastOdo) / litres).toFixed(1);
                        lastOdo = odo; localStorage.setItem('x_odo', odo);
                        petrol.unshift({ date: txn.date, amt, litres, mileage, odo });
                        localStorage.setItem('x_petrol', JSON.stringify(petrol));
                        note = `${litres}L @ ‚Çπ${price} (Mileage: ${mileage})`;
                        alert(`Mileage: ${mileage} km/L`);
                    }
                }
            }
            if(note) txn.note = note;
            txns.unshift(txn); localStorage.setItem('x_txns', JSON.stringify(txns));
            document.getElementById('amt').value = ''; document.getElementById('person').value = '';
            displayDate = new Date(); refreshView(); tab('home', document.querySelectorAll('.nav-item')[0]);
        }

        // --- LIST & DELETE ---
        function renderList(data) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('txn-list').innerHTML = data.length ? data.map(t => {
                let extra = "";
                if(t.type === 'lent' && t.due) {
                    if(t.due <= today) extra = `<span class="due-tag">‚ö†Ô∏è DUE</span>`;
                    else extra = `<span style="font-size:10px; color:#666; margin-left:5px">Due: ${t.due}</span>`;
                }
                const amtStr = t.amt.toLocaleString('en-IN');
                return `
                <div class="txn" onmousedown="startPress(${t.id}, this)" ontouchstart="startPress(${t.id}, this)" onmouseup="cancelPress(this)" ontouchend="cancelPress(this)">
                    <div><div style="font-weight:600">${t.cat} ${extra}</div><div style="font-size:12px; color:var(--sub)">${new Date(t.date).toLocaleDateString()} ${t.note?'‚Ä¢ '+t.note:''}</div></div>
                    <div class="${t.type==='income'?'inc':(t.type==='lent'?'lent':'exp')}">${t.type==='income'?'+':'-'}‚Çπ${amtStr}</div>
                </div>`;
            }).join('') : `<div style="text-align:center; padding:20px; color:var(--sub)">No transactions.</div>`;
        }

        function startPress(id, el) {
            el.classList.add('deleting');
            pressTimer = setTimeout(() => {
                if(confirm("Delete this transaction?")) {
                    txns = txns.filter(t => t.id !== id);
                    localStorage.setItem('x_txns', JSON.stringify(txns));
                    refreshView();
                }
                el.classList.remove('deleting');
            }, 800);
        }
        function cancelPress(el) { clearTimeout(pressTimer); el.classList.remove('deleting'); }

        // --- UTILS ---
        function updateGreeting() {
            const hr = new Date().getHours();
            let greet = "Good Morning,";
            if(hr >= 12) greet = "Good Afternoon,";
            if(hr >= 17) greet = "Good Evening,";
            document.getElementById('greet-time').innerText = greet;
            document.getElementById('user-display').innerText = user.name;
        }

        function togglePrivacy() {
            privacyMode = !privacyMode;
            document.getElementById('balance').classList.toggle('blur-mode', privacyMode);
        }

        function checkFields() { const cat = document.getElementById('cat').value; document.getElementById('petrol-fields').style.display = (cat === '‚õΩ Petrol' && currentType === 'expense') ? 'block' : 'none'; }
        function changeMonth(dir) { displayDate.setMonth(displayDate.getMonth() + dir); refreshView(); }
        function renderPetrolList() { document.getElementById('odo-display').innerText = `Odo: ${lastOdo} km`; const valid = petrol.filter(p => p.mileage > 0); if(valid.length) { const avg = (valid.reduce((a,b)=>a+parseFloat(b.mileage),0) / valid.length).toFixed(1); document.getElementById('avg-mileage').innerText = `${avg} km/L`; } document.getElementById('petrol-list').innerHTML = petrol.slice(0, 10).map(p => `<div class="txn"><div><div style="font-weight:600">${new Date(p.date).toLocaleDateString()}</div><div style="font-size:12px; color:var(--sub)">${p.litres}L ‚Ä¢ Odo: ${p.odo}</div></div><div style="text-align:right"><div style="font-weight:bold">‚Çπ${p.amt}</div><div style="font-size:12px; color:${p.mileage>35?'var(--success)':'var(--warn)'}">${p.mileage} km/L</div></div></div>`).join(''); }
        function renderStats(data) { const map = {}; let total = 0; data.filter(t => t.type === 'expense').forEach(t => { map[t.cat] = (map[t.cat] || 0) + t.amt; total += t.amt; }); let html = ""; for(let [c, amt] of Object.entries(map)) { let pct = total > 0 ? (amt / total * 100) : 0; html += `<div class="stat-item"><div class="stat-header"><span>${c}</span><span>‚Çπ${amt.toLocaleString('en-IN')} (${Math.round(pct)}%)</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`; } document.getElementById('stats-container').innerHTML = html; }
        function updateBudget(monthlyTxns) { const spent = monthlyTxns.filter(t => t.type === 'expense').reduce((a,b)=>a+b.amt,0); const limit = user.budget || 20000; const pct = Math.min((spent / limit) * 100, 100); document.getElementById('spent-display').innerText = `‚Çπ${spent.toLocaleString('en-IN')} Spent`; document.getElementById('budget-display').innerText = `Target: ‚Çπ${parseInt(limit).toLocaleString('en-IN')}`; const fill = document.getElementById('budget-fill'); fill.style.width = pct + "%"; document.getElementById('budget-line').style.width = pct + "%"; let color = 'var(--primary)'; if(pct > 50) color = 'var(--warn)'; if(pct > 90) color = 'var(--danger)'; document.getElementById('budget-line').style.background = color; fill.style.background = `linear-gradient(90deg, ${color}, transparent)`; }
        function editBudget(e) { e.stopPropagation(); const newB = prompt("Monthly Target (‚Çπ):", user.budget); if(newB && !isNaN(newB)) { user.budget = newB; localStorage.setItem('x_user', JSON.stringify(user)); refreshView(); } }
        function calculateBal() { return txns.reduce((a,t) => t.type==='income'?a+t.amt:a-t.amt, 0); }
        function updateBal() { document.getElementById('balance').innerText = `‚Çπ${calculateBal().toLocaleString('en-IN')}`; }
        function editBalance() { let cur = calculateBal(); let real = prompt(`Actual Bank Balance?`); if(real && !isNaN(real)) { let diff = parseFloat(real) - cur; if(diff !== 0) { txns.unshift({ id: Date.now(), amt: Math.abs(diff), type: diff>0?'income':'expense', cat: '‚öôÔ∏è Correction', date: new Date().toLocaleDateString('en-US') }); localStorage.setItem('x_txns', JSON.stringify(txns)); refreshView(); } } }
        
        function renderNumpad() { const pad = document.getElementById('numpad'); [1,2,3,4,5,6,7,8,9,'C',0,'<'].forEach(n => { let b = document.createElement('div'); b.className = 'num-btn'; b.innerText = n==='<'?'‚å´':n; b.onclick = () => handlePin(n); pad.appendChild(b); }); }
        
        // --- PROFILE & EXPORT ---
        function requestNotifyPerm() { if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission(); }
        function setReminder() { const time = document.getElementById('notify-time').value; if(time) { user.notify = time; localStorage.setItem('x_user', JSON.stringify(user)); alert(`Reminder set for ${time} daily!`); requestNotifyPerm(); } }
        function checkReminder() { if(!user.notify) return; const now = new Date(); const current = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0'); const lastDate = localStorage.getItem('last_notify_date'); const today = now.toDateString(); if (current === user.notify && lastDate !== today && Notification.permission === "granted") { new Notification("Xpense Reminder", { body: "Don't forget to log your daily expenses!", icon: "https://via.placeholder.com/128" }); localStorage.setItem('last_notify_date', today); } }
        function tab(view, el) { if(navigator.vibrate) navigator.vibrate(5); document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById('view-'+view).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
        function openProfile() { document.getElementById('view-profile').style.display='block'; }
        function closeProfile() { document.getElementById('view-profile').style.display='none'; }
        function saveProfile() { const name = document.getElementById('user-name-in').value; const img = document.getElementById('profile-preview').src; if(name) user.name = name; if(img && img.startsWith('data:')) user.img = img; localStorage.setItem('x_user', JSON.stringify(user)); loadProfile(); closeProfile(); refreshView(); }
        function loadProfile() { if(user.img) { document.getElementById('header-avatar').src = user.img; document.getElementById('header-avatar').style.display='block'; document.getElementById('header-ph').style.display='none'; } document.getElementById('user-name-in').value = user.name; if(user.notify) document.getElementById('notify-time').value = user.notify; }
        function uploadImg() { const f = document.getElementById('file-in').files[0]; const r = new FileReader(); r.onload = e => { document.getElementById('profile-preview').src=e.target.result; document.getElementById('profile-preview').style.display='block'; }; if(f) r.readAsDataURL(f); }
        function exportCSV() { let csv = "Date,Type,Category,Amount\n" + txns.map(t => `${t.date},${t.type},${t.cat},${t.amt}`).join("\n"); let link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "xpense_data.csv"; link.click(); }
        function filterList() { const q = document.getElementById('search-box').value.toLowerCase(); const filtered = txns.filter(t => t.cat.toLowerCase().includes(q) || (t.person && t.person.toLowerCase().includes(q))); renderList(filtered); }

        init();
    </script>
</body>
</html>